#!/bin/sh

set -x
set -e
builddir="$1"
platform="$2"
subarch="$3"
platform_cpu=$(grep CONFIG_ROCKCHIP_RK configs/${platform}_defconfig)
case $platform_cpu in
    *3328=y) platform_cpu_type=rk3328 ;;
    *3399=y) platform_cpu_type=rk3399 ;;
    *3288=y) platform_cpu_type=rk3288 ;;
esac

if grep ^CONFIG_TPL_ROCKCHIP_BACK_TO_BROM=y ${builddir}/.config ; then
    loader=tpl
else
    loader=spl
fi
loader_image=${builddir}/${loader}/u-boot-${loader}.bin
if [ -f ${loader_image} ]; then
    ${builddir}/tools/mkimage -T rksd -n ${platform_cpu_type} \
               -d ${loader_image} \
               ${builddir}/u-boot-${loader}.rksd
    echo ${builddir}/u-boot-${loader}.rksd /usr/lib/u-boot/${platform}/ \
         >> debian/build/targets.${subarch}
fi

if grep ^CONFIG_SPL_ROCKCHIP_BACK_TO_BROM=y ${builddir}/.config ; then
   cat ${builddir}/u-boot-spl.rksd ${builddir}/u-boot.bin > ${builddir}/u-boot.rksd
   echo ${builddir}/u-boot.rksd /usr/lib/u-boot/${platform}/ \
       >> debian/build/targets.${subarch}
elif grep ^CONFIG_TPL_ROCKCHIP_BACK_TO_BROM=y ${builddir}/.config ; then
   cat ${builddir}/u-boot-tpl.rksd ${builddir}/spl/u-boot-spl.bin > ${builddir}/u-boot-tpl-spl.rksd
   echo ${builddir}/u-boot-tpl-spl.rksd /usr/lib/u-boot/${platform}/ \
       >> debian/build/targets.${subarch}
fi
